<?xml version="1.0" encoding="UTF-8" ?>
<!--

    Copyright (C) 2003-2007 eXo Platform SAS.

    This program is free software; you can redistribute it and/or
    modify it under the terms of the GNU Affero General Public License
    as published by the Free Software Foundation; either version 3
    of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, see<http://www.gnu.org/licenses/>.

-->
<!--
 **
 * Created by The eXo Platform SARL
 * Author : hoat_le
 *          hoatlevan@gmail.com
 * Jun 17, 2009
 *
-->
<Module>
	<ModulePrefs author="eXoPlatform"
		title="ViewerFriendsGadget"
		directory_title="ViewerFriendsGadget"
		title_url="http://www.exoplatform.org"
		description="Gadget for displaying viewer's friends">
		<Require feature="opensocial-0.7" />
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
	<![CDATA[
		<style type="text/css">
		
		</style>
		
		<script type="text/javascript">
			function ViewerFriend() {};
			
			ViewerFriend.prototype.init = function() {				
				viewerFriend.loadFriends();
			}
			
			
			ViewerFriend.prototype.loadFriends = function() {
				var req = opensocial.newDataRequest();
  			var opts = {};
	      opts[opensocial.DataRequest.PeopleRequestFields.FIRST] =  0;
	      opts[opensocial.DataRequest.PeopleRequestFields.MAX] = 40;
	      opts[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS] =
	                     [opensocial.Person.Field.AGE,
	                     opensocial.Person.Field.NAME,
	                     opensocial.Person.Field.GENDER,
	                     opensocial.Person.Field.PROFILE_URL,
	                     opensocial.Person.Field.THUMBNAIL_URL,
	                     opensocial.Person.Field.STATUS];
        //opts[opensocial.DataRequest.PeopleRequestFields.SORT_ORDER] = opensocial.DataRequest.SortOrder.NAME;
  			opts[opensocial.DataRequest.PeopleRequestFields.MAX] = 100;
  			req.add(req.newFetchPersonRequest("VIEWER", opts), 'viewer');
  			req.add(req.newFetchPeopleRequest("VIEWER_FRIENDS", opts), 'viewerFriends');
  			req.send(viewerFriend.onLoadFriends);
			}
			
			ViewerFriend.prototype.onLoadFriends = function(data) {
				var viewer = data.get('viewer').getData();
				var viewerFriends = data.get('viewerFriends').getData();
				// Display
				var viewerDisplay = "";
				var friendsDisplay = [];
				
				viewerDisplay = viewer.getDisplayName();
				
				if (viewerFriends != null) {
					viewerFriends.each(function(person) {
    				if (person.getId()) {
      				friendsDisplay.push('<li>' + person.getDisplayName() + "</li>");
      			}
   				 });
				} else {
					friendDisplay = viewerDisplay + " has no friends yet.";
				}
				
				var viewerEl = document.getElementById("viewer");
				var friendsEl = document.getElementById("friends");
				viewerEl.innerHTML = viewerDisplay;
				friendsEl.innerHTML = "<ul>" + friendsDisplay.join() + "</ul";
			}
			
			var viewerFriend = new ViewerFriend();
			
			gadgets.util.registerOnLoadHandler(viewerFriend.init);
		</script>
		<div id="friendViewer">
			<div>Viewer: <span id="viewer"></span></div>
			<p>Viewer's friends:</p>
			<div id="friends"></div>
		</div>
	]]>
	</Content>
</Module>